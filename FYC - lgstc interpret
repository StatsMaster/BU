
/* the best models appear to inputs of 25 */

%let TDS  = FYC_T_v2 ;
%let VDS  = FYC_V_v2 ;
%let vars = 
VM_FLAG
EMV_FLAG
X_VM_FLAG_CHN_GRP_7
PMV_SR
X_PMV_SR_Biz_TiYODSEQ
X_PMV_SR_CHN_GRP_1
Biz_TiYODSEQ
IND_GRP_3
IND_GRP_6
IND_GRP_8
IND_GRP_9
CHN_GRP_2
CHN_GRP_3
CHN_GRP_6
GEO_GRP_1
GEO_GRP_2
GEO_GRP_4
B_PAT
POS_GRP_1
POS_GRP_3
POS_C
POS_GRP_6
PTY_GRP_1
PTY_GRP_2
;


Proc Logistic Data = &TDS. outmodel = mod.FYC_MODEL;
	Model Quick_Close (event='1') = &vars.
	/ STB RSQ ;
	Score 
		data 		= &VDS.
		out	 		= &VDS._S;
Run ;

proc logistic data = &VDS._S des;
	model quick_close (event='1') = P_1 ;
run;

/* ROC Optimal Point */

/*
proc logistic data = &tds.;
	Model Quick_Close (event='1') = &vars.
	/ outroc=o ROCEPS=0;
 output out=model1 pred=phat;
run;
proc sql;
 create table annodat as
 	select *, 
	'draw' 		as Function, 
	1 			as Line, 
	'red' 		as color, 
	_1mspec_ 	as X, 
	_sensit_ 	as Y, 
	'2' 		as xsys, 
	'2' 		as ysys
 from 	
	(select *, 
	sqrt((0-_1mspec_)**2+(1-_sensit_)**2) 		as Dist, 
	min(sqrt((0-_1mspec_)**2+(1-_sensit_)**2)) 	as Min 
	from work.o)
 where dist=min;
 title 'Point where Distance is Minimized';
 select dist, _sensit_, _1mspec_, _PROB_ Length=8 Format 10.8
 from annodat;
 select _PROB_ Length=8 Format 10.8 into: ROC_POINT from annodat;
quit;
title;
data example;
 retain xsys ysys hsys '2';
 function = 'move'; x=0; y=1; output;
run;
data newanno;
 set example annodat;
run;
proc gplot data=o anno=newanno;
 plot _Sensit_*_1mspec_;
run;
quit;

*/

data &VDS._S_v2;
 set &VDS._S;
 if P_1 >= &ROC_POINT.  then Pred_Attrition = 1; else Pred_Attrition = 0;
run;

title "cMatrix";
Proc Freq data = &VDS._S_v2 ;
	Tables Quick_Close*Pred_Attrition / norow nocol nocum nofreq;
Run;
title;

title "cMatrix";
Proc Freq data = &VDS._S_v2 ;
	Tables Quick_Close*Pred_Attrition / norow nocol nocum nopercent;
Run;
title;

Proc Rank
	data = &VDS._S_v2
	out  = &VDS._S_v3
	Groups = 10 ;
	Var P_1 ;
	Ranks FYC;
Run;

data &VDS._S_v3; set &VDS._S_v3; FYC = FYC+1; run;

Proc Freq data = &VDS._S_v3 ;
	Tables FYC*Quick_Close / nocol nopercent nofreq;
Run;

Proc Means data = &VDS._S_v3 mean;
	class FYC ;
	var P_1 ;
run;

proc print data = &VDS._S_v3 (obs=10);
	where FYC = 100;
run;

/* Profile Bottom -- Middle -- Top customers */

proc means data =  &VDS._S_v3 min mean max; where FYC = 10; var &vars.; run;
proc means data =  &VDS._S_v3 min mean max; where FYC =  5; var &vars.; run;
proc means data =  &VDS._S_v3 min mean max; where FYC =  1; var &vars.; run;

proc means data =  &VDS._S_v3 min mean max; class FYC; var biz_tiy; run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var pat; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var pmv; 	run;

proc means data =  &VDS._S_v3 min mean max; class FYC; var VM_FLAG; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var EMV_FLAG; 	run;

proc means data =  &VDS._S_v3 min mean max; class FYC; var X_VM_FLAG_CHN_GRP_7; 	run;

proc means data =  &VDS._S_v3 min mean max; class FYC; var POS_GRP_1 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var POS_GRP_3 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var POS_GRP_6 ; 	run;

proc means data =  &VDS._S_v3 min mean max; class FYC; var IND_GRP_3 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var IND_GRP_6 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var IND_GRP_8 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var IND_GRP_9 ; 	run;

proc means data =  &VDS._S_v3 min mean max; class FYC; var GEO_GRP_1 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var GEO_GRP_2 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var GEO_GRP_3 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var GEO_GRP_4 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var GEO_GRP_5 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var GEO_GRP_6 ; 	run;

proc means data =  &VDS._S_v3 min mean max; class FYC; var CHN_GRP_1 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var CHN_GRP_2 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var CHN_GRP_3 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var CHN_GRP_4 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var CHN_GRP_6 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var CHN_GRP_7 ; 	run;

proc means data =  &VDS._S_v3 min mean max; class FYC; var PTY_GRP_1 ; 	run;
proc means data =  &VDS._S_v3 min mean max; class FYC; var PTY_GRP_2 ; 	run;

proc freq data =  &VDS._S_v3 ; 
	tables CHN_GRP*FYC / missing nopercent norow nocol; 	
run ;

/* Corr with prob to inputs */

proc corr data= &VDS._S_v3 ;
	var P_1  
VM_FLAG
PMV_SR
X_PMV_SR_Biz_TiYODSEQ
B_PAT
EMV_FLAG
Biz_TiYODSEQ
;
run ;

proc means data= &VDS._S_v3 mean maxdec=4;
	class VM_FLAG ;
	var P_1 ;
run ;

proc means data= &VDS._S_v3 mean maxdec=4;
	class EMV_FLAG ;
	var P_1 ;
run ;

proc means data= &VDS._S_v3 mean;
	class FYC;
	var B_PAT;
run ;

proc means data= &VDS._S_v3 mean;
	class FYC; var X_PMV_SR_Biz_TiYODSEQ ;
proc means data= &VDS._S_v3 mean;
	class FYC; var PMV_SR;
proc means data= &VDS._S_v3 mean; 
	class FYC; var Biz_TiYODSEQ;
run;




proc means data= &VDS._S_v3 min max maxdec=4;
	class Biz_TiYODSEQ ;
	var Biz_TiY;
run ;

proc means data= &VDS._S_v3 mean maxdec=4;
	class Biz_TiYODSEQ ;
	var P_1 Biz_TiY;
run ;

proc means data= &VDS._S_v3 mean maxdec=4;
	class POS_GRP_6 ;
	var P_1 ;
run ;

/*
X_PMV_SR_Biz_TiYODSEQ
X_PMV_SR_CHN_GRP_1

IND_GRP_3
IND_GRP_6
IND_GRP_8
IND_GRP_9

CHN_GRP_2
CHN_GRP_3
CHN_GRP_6

GEO_GRP_1
GEO_GRP_2
GEO_GRP_4

POS_GRP_1
POS_GRP_3

POS_C

PTY_GRP_1
PTY_GRP_2
*/



%CAT_CLUSTERING(DSN = &dsn., RSP=Quick_Close, CAT=SIC ,  			NewVar=IND )
%CAT_CLUSTERING(DSN = &dsn., RSP=Quick_Close, CAT=CRR ,  			NewVar=CHN )
%CAT_CLUSTERING(DSN = &dsn., RSP=Quick_Close, CAT=STATE, 			NewVar=GEO )
%CAT_CLUSTERING(DSN = &dsn., RSP=Quick_Close, CAT=Terminal_Key , 	NewVar=POS )
%CAT_CLUSTERING(DSN = &dsn., RSP=Quick_Close, CAT=PRICING_TYPE ,    NewVar=PTY )


proc freq data=&VDS._S_v3; tables CHN_GRP*CRR   		/ list missing; run;
proc freq data=&VDS._S_v3; tables IND_GRP*SIC   		/ list missing; run;
proc freq data=&VDS._S_v3; tables GEO_GRP*STATE 		/ list missing; run;
proc freq data=&VDS._S_v3; tables POS_GRP*Terminal_Key	/ list missing; run;

proc freq data=&VDS._S_v3; tables PTY_GRP*PRICING_TYPE	/ list missing; run;
